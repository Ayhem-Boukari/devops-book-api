# CD Pipeline - Continuous Deployment
# =====================================
# This workflow deploys the application to Kubernetes after CI passes.
# It runs only on pushes to the main branch.

name: CD Pipeline

on:
  push:
    branches: [main]
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [main]

env:
  DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/devops-book-api

jobs:
  # ==================== DEPLOY TO KUBERNETES ====================
  deploy:
    name: üöÄ Deploy to Kubernetes
    runs-on: ubuntu-latest
    # Only run if CI passed (when triggered by workflow_run)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Update deployment image tag
        run: |
          # Update the image tag in deployment.yaml
          sed -i "s|image: devops-book-api:latest|image: ${{ env.DOCKER_IMAGE }}:${{ github.sha }}|g" k8s/deployment.yaml

      - name: Apply Kubernetes namespace
        run: kubectl apply -f k8s/namespace.yaml

      - name: Apply Kubernetes ConfigMap
        run: kubectl apply -f k8s/configmap.yaml

      - name: Apply Kubernetes Deployment
        run: kubectl apply -f k8s/deployment.yaml

      - name: Apply Kubernetes Service
        run: kubectl apply -f k8s/service.yaml

      - name: Apply Kubernetes Ingress
        run: kubectl apply -f k8s/ingress.yaml

      - name: Wait for deployment rollout
        run: |
          kubectl rollout status deployment/devops-book-api \
            -n devops-book-api \
            --timeout=300s

      - name: Verify deployment
        run: |
          echo "=== Deployment Status ==="
          kubectl get deployment devops-book-api -n devops-book-api
          echo ""
          echo "=== Pods Status ==="
          kubectl get pods -n devops-book-api -l app=devops-book-api
          echo ""
          echo "=== Service Status ==="
          kubectl get service devops-book-api -n devops-book-api

      - name: Run smoke tests
        run: |
          # Port forward to test the deployment
          kubectl port-forward svc/devops-book-api 8080:80 -n devops-book-api &
          sleep 5
          # Health check
          curl -f http://localhost:8080/health || exit 1
          echo "‚úÖ Smoke tests passed!"

  # ==================== ROLLBACK ON FAILURE ====================
  rollback:
    name: ‚è™ Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    steps:
      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config

      - name: Rollback deployment
        run: |
          kubectl rollout undo deployment/devops-book-api -n devops-book-api
          echo "‚è™ Rolled back to previous version"

  # ==================== NOTIFY ====================
  notify:
    name: üì¢ Notify Deployment Status
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Deployment notification
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
            echo "Image: ${{ env.DOCKER_IMAGE }}:${{ github.sha }}"
          else
            echo "‚ùå Deployment failed!"
          fi
